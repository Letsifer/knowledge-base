# Аномалии и уровни транзакции в PostgreSQL.md

Основные требования к СУБД (ACID)
* **Atomicity** (атомарность) — выражается в том, что транзакция должна быть выполнена в целом или не выполнена вовсе.
* **Consistency** (согласованность) — гарантирует, что по мере выполнения транзакций, данные переходят из одного согласованного состояния в другое, то есть транзакция не может разрушить взаимной согласованности данных.
Иначе говоря, все инварианты по окончанию транзакции сохраняются (**Инвариант** — некоторое утверждение о данных, которое остается неизменным на протяжении выполнения программы.)
* **Isolation** (изолированность) — локализация пользовательских процессов означает, что конкурирующие за доступ к БД транзакции физически обрабатываются последовательно, изолированно друг от друга, но для пользователей это выглядит, как будто они выполняются параллельно.
* **Durability** (долговечность, устойчивость к ошибкам) —  — если транзакция завершена успешно, то те изменения в данных, которые были ею произведены, не могут быть потеряны ни при каких обстоятельствах.

Стандарт SQL предполагает возможность следующих аномалии конкурентного доступа.

В примерах учитываем, что currency должно быть больше 0.

#### Потерянное обновление (lost update) 
Две транзакции читают одну и ту же строку таблицы, затем одна из ниж обновляет эту строку, после чего вторая тоже обновляет это строку, не учитывая
изменения первой транзакции
Transaction 1: select currency from account where id = 1 -- 100
Transaction 2: select currency from account where id = 1 -- 100
Transaction 1: update account set currency = currency + 100 where id = 1 -- 200
Transaction 2: update account set currency = currency + 200 where id = 1 -- 300, а должно быть 400

#### Грязное чтение
Транзакция читает не зафиксированные изменения, сделанные другой транзакцией. Особенно опасно тем, что другая транзакция может откатить изменения, из-за чего
первая транзакция будет работать с данными, которых нет
Transaction 1: select currency from account where id = 1 -- 100
Transaction 1: update account set currency = currency + 50 where id = 1 -- 150
Transaction 2: select currency from account where id = 1 -- 150, хотя 1 транзакция еще не сделала commit
Transaction 1: rollback;
Transaction 1: update account set currency = currency - 150 where id = 1 -- -50, что некорректно - инвариант нарушен

#### Неповторяющееся чтение
Транзакция читает одну и ту же строку два раза, межде этими чтениями другая транзакция изменяет или удаляет эту строку с фиксацией изменений.
Transaction 1: select currency from account where id = 1 -- 1000
Transaction 2: update account set currency = 0 where id = 1 -- 0
Transaction 2: commit;
Transaction 1: update account set currency -= 200 where id = 1 -- сумма на счете -200, т.е. меньше 0 - инвариант нарушен

#### Фантомное чтение
Транзакция читает два раза с одним и тем же условием, межде этими чтениями другая транзакция добавляет строки, удовлетворяющие этому условию, и фиксирует изменения
Первая транзакция получает разный набор строк. 
В этом примере учитываем, что сумма всех currency на счетах должна быть больше 0.
Transaction 1: select sum(currency) from account where user_id = 1 -- 1000
Transaction 2: insert into account(currency) values(-500)
Transaction 2: commit;
Transaction 1: update account set currency -= 700 where id = 1 -- сумма по всем счетам -200, т.е. меньше 0 - инвариант нарушен

#### Прочие аномалии
При этом существует еще много известных аномалий, не попавших в стандарт, также неизвестно, сколько есть неизвестных аномалий.

### Уровни транзакции
Всего в стандарте сущестуют следующие уровни транзакций, корректно обрабатывающие вышеописанные аномалии
| Уровень | Потерянное изменение | Грязное чтение | Неповторяющееся чтение | Фантомное чтение | Прочие | Комментарий |
| :---: | :---: | :---: | :---: | :---: | :---: | --- |
| `Read uncommited` | Да | - | - |  - |  - |  Отсутствует в PostgreSQL | 
| `Read commited` | Да | Да | - |  - |  - |  Значение по умолчанию |
| `Repeatable read` | Да | Да | Да |  - (Да, в PostgreSQL) |  - | При параллельном обновлении одной и той же строки получим ошибку сериализации  |
| `Serializable` |  Да | Да | Да | Да | Да | При параллельном обновлении одной и той же строки получим ошибку сериализации. Однакоread only транзакции могут быть откладываемыми (deferrable), если настроено |

Источники:
1. Егор Рогов. PostgreSQL 16 изнутри. Раздел 2.2 "Уровни изоляции и аномалии в стандарте SQL" - https://edu.postgrespro.ru/postgresql_internals-16.pdf
2. Бэкэнд для начинающих или типовые ошибки бэкэндера - https://habr.com/ru/companies/tensor/articles/813627/
3. Уровни изоляции транзакций с примерами на PostgreSQL - https://habr.com/ru/articles/317884/
